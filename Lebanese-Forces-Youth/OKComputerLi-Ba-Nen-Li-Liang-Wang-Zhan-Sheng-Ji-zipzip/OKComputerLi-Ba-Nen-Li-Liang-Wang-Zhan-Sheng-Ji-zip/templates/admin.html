<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Lebanese Forces Youth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { background-color: #DC143C; color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-red-600 rounded-full flex items-center justify-center">
                    <span class="text-white font-bold">LF</span>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-red-600">Admin Panel</h1>
                    <p class="text-xs text-gray-500">Lebanese Forces Youth</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600">Welcome, {{ user.username or 'Admin' }}</span>
                <a href="/" class="text-gray-600 hover:text-red-600">View Site</a>
                <a href="/logout" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="flex border-b flex-wrap">
                <button class="tab-btn active px-6 py-4 font-medium" data-tab="appearance">Appearance</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-red-600" data-tab="content">Site Content</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-red-600" data-tab="visual-editor">Visual Editor</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-red-600" data-tab="news">News Articles</button>
                <button class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-red-600" data-tab="timeline">Timeline Events</button>
            </div>
        </div>

        <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center space-x-3">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <div>
                        <h3 class="font-semibold text-amber-800">Preview Your Changes</h3>
                        <p class="text-sm text-amber-600">See how your site looks before visitors do</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="previewPage('index.html')" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600 text-sm font-medium">Preview Home</button>
                    <button onclick="previewPage('timeline.html')" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600 text-sm font-medium">Preview Timeline</button>
                    <button onclick="previewPage('comparison.html')" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600 text-sm font-medium">Preview Comparison</button>
                    <button onclick="previewPage('news.html')" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600 text-sm font-medium">Preview News</button>
                    <button onclick="previewPage('join.html')" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600 text-sm font-medium">Preview Join</button>
                </div>
            </div>
        </div>

        <div id="appearance" class="tab-content active">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Appearance Settings</h2>
                <form id="appearanceForm" class="space-y-6">
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" name="primary_color" value="{{ config.get('primary_color', '#DC143C') }}" class="w-12 h-10 rounded border cursor-pointer">
                                <input type="text" value="{{ config.get('primary_color', '#DC143C') }}" class="flex-1 border rounded px-3 py-2" id="primary_color_text">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Secondary Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" name="secondary_color" value="{{ config.get('secondary_color', '#228B22') }}" class="w-12 h-10 rounded border cursor-pointer">
                                <input type="text" value="{{ config.get('secondary_color', '#228B22') }}" class="flex-1 border rounded px-3 py-2" id="secondary_color_text">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" name="accent_color" value="{{ config.get('accent_color', '#FFD700') }}" class="w-12 h-10 rounded border cursor-pointer">
                                <input type="text" value="{{ config.get('accent_color', '#FFD700') }}" class="flex-1 border rounded px-3 py-2" id="accent_color_text">
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Heading Font</label>
                            <select name="font_heading" class="w-full border rounded px-3 py-2">
                                <option value="Inter" {{ 'selected' if config.get('font_heading') == 'Inter' else '' }}>Inter</option>
                                <option value="Playfair Display" {{ 'selected' if config.get('font_heading') == 'Playfair Display' else '' }}>Playfair Display</option>
                                <option value="Roboto" {{ 'selected' if config.get('font_heading') == 'Roboto' else '' }}>Roboto</option>
                                <option value="Open Sans" {{ 'selected' if config.get('font_heading') == 'Open Sans' else '' }}>Open Sans</option>
                                <option value="Montserrat" {{ 'selected' if config.get('font_heading') == 'Montserrat' else '' }}>Montserrat</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Body Font</label>
                            <select name="font_body" class="w-full border rounded px-3 py-2">
                                <option value="Inter" {{ 'selected' if config.get('font_body') == 'Inter' else '' }}>Inter</option>
                                <option value="Roboto" {{ 'selected' if config.get('font_body') == 'Roboto' else '' }}>Roboto</option>
                                <option value="Open Sans" {{ 'selected' if config.get('font_body') == 'Open Sans' else '' }}>Open Sans</option>
                                <option value="Lato" {{ 'selected' if config.get('font_body') == 'Lato' else '' }}>Lato</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Save Appearance</button>
                </form>
            </div>
        </div>

        <div id="content" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Site Content</h2>
                <form id="contentForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
                            <input type="text" name="site_title" value="{{ config.get('site_title', 'Lebanese Forces Youth') }}" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Site Subtitle</label>
                            <input type="text" name="site_subtitle" value="{{ config.get('site_subtitle', 'Educational Platform') }}" class="w-full border rounded px-3 py-2">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hero Title</label>
                        <input type="text" name="hero_title" value="{{ config.get('hero_title', 'Lebanese Forces Youth') }}" class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hero Subtitle</label>
                        <textarea name="hero_subtitle" rows="3" class="w-full border rounded px-3 py-2">{{ config.get('hero_subtitle', '') }}</textarea>
                    </div>
                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Save Content</button>
                </form>
            </div>
        </div>

        <div id="visual-editor" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Visual Page Editor</h2>
                        <p class="text-sm text-gray-500 mt-1">Edit your pages visually - just like Wix or GoDaddy</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="editorPageSelect" class="border rounded px-4 py-2">
                            <option value="index.html">Home Page</option>
                            <option value="timeline.html">Timeline</option>
                            <option value="comparison.html">Comparison</option>
                            <option value="news.html">News</option>
                            <option value="join.html">Join</option>
                        </select>
                        <button onclick="loadEditorPage()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Load Page</button>
                    </div>
                </div>
                
                <div class="grid lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-1 space-y-4">
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 mb-3">Quick Edit Tools</h3>
                            <div class="space-y-3">
                                <button onclick="toggleEditMode()" id="editModeBtn" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                                    Enable Edit Mode
                                </button>
                                <button onclick="saveEditorChanges()" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">
                                    Save All Changes
                                </button>
                            </div>
                        </div>
                        
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 mb-3">Instructions</h3>
                            <ul class="text-sm text-gray-600 space-y-2">
                                <li class="flex items-start space-x-2">
                                    <span class="text-green-600">1.</span>
                                    <span>Load the page you want to edit</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <span class="text-green-600">2.</span>
                                    <span>Enable Edit Mode to make changes</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <span class="text-green-600">3.</span>
                                    <span>Click on any text to edit it directly</span>
                                </li>
                                <li class="flex items-start space-x-2">
                                    <span class="text-green-600">4.</span>
                                    <span>Save changes when done</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold text-gray-700 mb-3">Element Styles</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Text Color</label>
                                    <input type="color" id="editorTextColor" value="#333333" class="w-full h-8 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Background Color</label>
                                    <input type="color" id="editorBgColor" value="#ffffff" class="w-full h-8 rounded cursor-pointer">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">Font Size</label>
                                    <select id="editorFontSize" class="w-full border rounded px-2 py-1 text-sm">
                                        <option value="12px">Small</option>
                                        <option value="16px" selected>Normal</option>
                                        <option value="20px">Large</option>
                                        <option value="24px">Extra Large</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-3">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg overflow-hidden bg-gray-50" style="min-height: 600px;">
                            <div class="bg-gray-100 border-b px-4 py-2 flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div class="flex space-x-1">
                                        <span class="w-3 h-3 rounded-full bg-red-400"></span>
                                        <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
                                        <span class="w-3 h-3 rounded-full bg-green-400"></span>
                                    </div>
                                    <span class="text-sm text-gray-500 ml-4" id="editorUrl">Select a page to edit</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="setEditorView('desktop')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Desktop</button>
                                    <button onclick="setEditorView('tablet')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Tablet</button>
                                    <button onclick="setEditorView('mobile')" class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">Mobile</button>
                                </div>
                            </div>
                            <iframe id="editorFrame" class="w-full bg-white" style="height: 600px; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="news" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">News Articles</h2>
                    <button onclick="showNewsModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Add Article</button>
                </div>
                <div id="newsList" class="space-y-4">
                    {% for article in news %}
                    <div class="border rounded-lg p-4 flex justify-between items-center" data-id="{{ article.id }}">
                        <div>
                            <h3 class="font-medium">{{ article.title }}</h3>
                            <p class="text-sm text-gray-500">{{ article.category }} | {{ article.date }}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editNews({{ article.id }})" class="text-blue-600 hover:text-blue-800">Edit</button>
                            <button onclick="deleteNews({{ article.id }})" class="text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="timeline" class="tab-content">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Timeline Events</h2>
                    <button onclick="showTimelineModal()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Add Event</button>
                </div>
                <div id="timelineList" class="space-y-4">
                    {% for event in timeline %}
                    <div class="border rounded-lg p-4 flex justify-between items-center" data-id="{{ event.id }}">
                        <div>
                            <h3 class="font-medium">{{ event.year }} - {{ event.title }}</h3>
                            <p class="text-sm text-gray-500">{{ event.description[:100] }}...</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editTimeline({{ event.id }})" class="text-blue-600 hover:text-blue-800">Edit</button>
                            <button onclick="deleteTimeline({{ event.id }})" class="text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>

    <div id="newsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
            <h3 class="text-xl font-bold mb-4" id="newsModalTitle">Add News Article</h3>
            <form id="newsForm" class="space-y-4">
                <input type="hidden" id="newsId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="newsTitle" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="newsCategory" class="w-full border rounded px-3 py-2">
                        <option value="political">Political</option>
                        <option value="economic">Economic</option>
                        <option value="international">International</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="newsContent" rows="4" class="w-full border rounded px-3 py-2" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Read Time</label>
                    <input type="text" id="newsReadTime" value="3 min read" class="w-full border rounded px-3 py-2">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideNewsModal()" class="px-4 py-2 border rounded hover:bg-gray-100">Cancel</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timelineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
            <h3 class="text-xl font-bold mb-4" id="timelineModalTitle">Add Timeline Event</h3>
            <form id="timelineForm" class="space-y-4">
                <input type="hidden" id="timelineId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                        <input type="text" id="timelineYear" class="w-full border rounded px-3 py-2" required placeholder="e.g., 1976">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Order</label>
                        <input type="number" id="timelineOrder" value="0" class="w-full border rounded px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="timelineTitle" class="w-full border rounded px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="timelineDescription" rows="4" class="w-full border rounded px-3 py-2" required></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideTimelineModal()" class="px-4 py-2 border rounded hover:bg-gray-100">Cancel</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Declare all variables at the top
        let editorEditMode = false;
        let currentEditorPage = null;
        let editorChanges = {};
        let selectedElement = null;

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAdmin);
        } else {
            initAdmin();
        }

        function initAdmin() {
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });

            // Color input sync
            document.querySelectorAll('input[type="color"]').forEach(input => {
                const textInput = input.nextElementSibling;
                if (textInput) {
                    input.addEventListener('input', () => textInput.value = input.value);
                    textInput.addEventListener('input', () => input.value = textInput.value);
                }
            });

            // Form submissions
            const appearanceForm = document.getElementById('appearanceForm');
            const contentForm = document.getElementById('contentForm');
            const newsForm = document.getElementById('newsForm');
            const timelineForm = document.getElementById('timelineForm');

            if (appearanceForm) appearanceForm.addEventListener('submit', handleAppearanceSubmit);
            if (contentForm) contentForm.addEventListener('submit', handleContentSubmit);
            if (newsForm) newsForm.addEventListener('submit', handleNewsSubmit);
            if (timelineForm) timelineForm.addEventListener('submit', handleTimelineSubmit);

            // Editor color inputs
            const editorTextColor = document.getElementById('editorTextColor');
            const editorBgColor = document.getElementById('editorBgColor');
            const editorFontSize = document.getElementById('editorFontSize');

            if (editorTextColor) editorTextColor.addEventListener('input', function() {
                applyStyleToSelected('color', this.value);
            });
            if (editorBgColor) editorBgColor.addEventListener('input', function() {
                applyStyleToSelected('backgroundColor', this.value);
            });
            if (editorFontSize) editorFontSize.addEventListener('change', function() {
                applyStyleToSelected('fontSize', this.value);
            });
        }

        async function handleAppearanceSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to save');
                alert('Appearance saved! Refreshing page to show changes...');
                location.reload();
            } catch (error) {
                alert('Error saving appearance: ' + error.message);
            }
        }

        async function handleContentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to save');
                alert('Content saved! Refreshing page to show changes...');
                location.reload();
            } catch (error) {
                alert('Error saving content: ' + error.message);
            }
        }

        function showNewsModal() {
            document.getElementById('newsModalTitle').textContent = 'Add News Article';
            document.getElementById('newsId').value = '';
            document.getElementById('newsTitle').value = '';
            document.getElementById('newsCategory').value = 'political';
            document.getElementById('newsContent').value = '';
            document.getElementById('newsReadTime').value = '3 min read';
            document.getElementById('newsModal').classList.remove('hidden');
        }

        function hideNewsModal() {
            document.getElementById('newsModal').classList.add('hidden');
        }

        function showTimelineModal() {
            document.getElementById('timelineModalTitle').textContent = 'Add Timeline Event';
            document.getElementById('timelineId').value = '';
            document.getElementById('timelineYear').value = '';
            document.getElementById('timelineTitle').value = '';
            document.getElementById('timelineDescription').value = '';
            document.getElementById('timelineOrder').value = '0';
            document.getElementById('timelineModal').classList.remove('hidden');
        }

        function hideTimelineModal() {
            document.getElementById('timelineModal').classList.add('hidden');
        }

        async function handleNewsSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('newsId').value;
            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                content: document.getElementById('newsContent').value,
                read_time: document.getElementById('newsReadTime').value,
                is_published: true
            };
            const url = id ? `/api/news/${id}` : '/api/news';
            const method = id ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to save article');
                hideNewsModal();
                location.reload();
            } catch (error) {
                alert('Error saving article: ' + error.message);
            }
        }

        async function handleTimelineSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('timelineId').value;
            const data = {
                year: document.getElementById('timelineYear').value,
                title: document.getElementById('timelineTitle').value,
                description: document.getElementById('timelineDescription').value,
                order: parseInt(document.getElementById('timelineOrder').value)
            };
            const url = id ? `/api/timeline/${id}` : '/api/timeline';
            const method = id ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to save event');
                hideTimelineModal();
                location.reload();
            } catch (error) {
                alert('Error saving event: ' + error.message);
            }
        }

        async function deleteNews(id) {
            if (confirm('Are you sure you want to delete this article?')) {
                try {
                    const res = await fetch(`/api/news/${id}`, {method: 'DELETE'});
                    if (!res.ok) throw new Error('Failed to delete');
                    location.reload();
                } catch (error) {
                    alert('Error deleting article: ' + error.message);
                }
            }
        }

        async function deleteTimeline(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                try {
                    const res = await fetch(`/api/timeline/${id}`, {method: 'DELETE'});
                    if (!res.ok) throw new Error('Failed to delete');
                    location.reload();
                } catch (error) {
                    alert('Error deleting event: ' + error.message);
                }
            }
        }


        async function editNews(id) {
            try {
                const res = await fetch(`/api/news/admin/${id}`);
                if (!res.ok) throw new Error('Failed to load article');
                const article = await res.json();
                document.getElementById('newsModalTitle').textContent = 'Edit News Article';
                document.getElementById('newsId').value = id;
                document.getElementById('newsTitle').value = article.title;
                document.getElementById('newsCategory').value = article.category;
                document.getElementById('newsContent').value = article.content;
                document.getElementById('newsReadTime').value = article.read_time;
                document.getElementById('newsModal').classList.remove('hidden');
            } catch (error) {
                alert('Error loading article: ' + error.message);
            }
        }

        async function editTimeline(id) {
            try {
                const res = await fetch(`/api/timeline/${id}`);
                if (!res.ok) throw new Error('Failed to load event');
                const event = await res.json();
                document.getElementById('timelineModalTitle').textContent = 'Edit Timeline Event';
                document.getElementById('timelineId').value = id;
                document.getElementById('timelineYear').value = event.year;
                document.getElementById('timelineTitle').value = event.title;
                document.getElementById('timelineDescription').value = event.description;
                document.getElementById('timelineOrder').value = event.order;
                document.getElementById('timelineModal').classList.remove('hidden');
            } catch (error) {
                alert('Error loading event: ' + error.message);
            }
        }

        function previewPage(page) {
            const previewUrl = '/' + page + '?preview=true';
            window.open(previewUrl, '_blank', 'width=1200,height=800');
        }

        function loadEditorPage() {
            const page = document.getElementById('editorPageSelect').value;
            currentEditorPage = page;
            const frame = document.getElementById('editorFrame');
            document.getElementById('editorUrl').textContent = window.location.origin + '/' + page;
            
            frame.onload = function() {
                setTimeout(injectEditorStyles, 500);
            };
            
            frame.onerror = function() {
                alert('Error loading page in editor. Please try again.');
            };
            
            frame.src = '/' + page + '?editor=true';
        }

        function injectEditorStyles() {
            const frame = document.getElementById('editorFrame');
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                const style = doc.createElement('style');
                style.textContent = `
                    .editor-highlight {
                        outline: 2px dashed #3b82f6 !important;
                        outline-offset: 2px;
                        cursor: pointer;
                    }
                    .editor-editing {
                        outline: 2px solid #22c55e !important;
                        outline-offset: 2px;
                        background: rgba(34, 197, 94, 0.1) !important;
                    }
                    .editor-toolbar {
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: #1f2937;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 8px;
                        z-index: 10000;
                        font-size: 12px;
                    }
                `;
                doc.head.appendChild(style);
            } catch (e) {
                console.log('Cannot inject styles - cross-origin restriction');
            }
        }

        function toggleEditMode() {
            editorEditMode = !editorEditMode;
            const btn = document.getElementById('editModeBtn');
            const frame = document.getElementById('editorFrame');
            
            if (editorEditMode) {
                btn.textContent = 'Disable Edit Mode';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-orange-600', 'hover:bg-orange-700');
                enableFrameEditing(frame);
            } else {
                btn.textContent = 'Enable Edit Mode';
                btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                disableFrameEditing(frame);
            }
        }

        function enableFrameEditing(frame) {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (!doc) {
                    alert('Cannot access page content. This may be due to browser security restrictions.');
                    return;
                }
                
                const toolbar = doc.createElement('div');
                toolbar.className = 'editor-toolbar';
                toolbar.id = 'editor-toolbar';
                toolbar.innerHTML = 'Edit Mode Active - Click on text to edit';
                doc.body.appendChild(toolbar);
                
                const editableElements = doc.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a, button, li, div[role="main"], section, article');
                if (editableElements.length === 0) {
                    alert('No editable elements found on this page.');
                    return;
                }
                
                let editIndex = 0;
                editableElements.forEach(el => {
                    if (el.textContent.trim().length === 0) return;
                    
                    const originalContent = el.innerHTML;
                    const originalStyle = el.getAttribute('style') || '';
                    
                    if (!el.hasAttribute('data-edit-id')) {
                        const stableId = el.id || 'edit-' + currentEditorPage.replace('.html', '') + '-' + editIndex;
                        el.setAttribute('data-edit-id', stableId);
                        editIndex++;
                    }
                    
                    el.setAttribute('contenteditable', 'true');
                    el.setAttribute('data-original', originalContent);
                    el.setAttribute('data-original-style', originalStyle);
                    el.classList.add('editor-highlight');
                    
                    el.addEventListener('focus', function() {
                        this.classList.remove('editor-highlight');
                        this.classList.add('editor-editing');
                    });
                    
                    el.addEventListener('blur', function() {
                        this.classList.remove('editor-editing');
                        this.classList.add('editor-highlight');
                        const contentChanged = this.innerHTML !== this.getAttribute('data-original');
                        const styleChanged = (this.getAttribute('style') || '') !== this.getAttribute('data-original-style');
                        if (contentChanged || styleChanged) {
                            this.setAttribute('data-edited', 'true');
                            this.style.borderLeft = '3px solid #22c55e';
                        }
                    });
                    
                    el.addEventListener('input', function() {
                        this.setAttribute('data-edited', 'true');
                    });
                });
            } catch (e) {
                console.error('Edit mode error:', e);
                alert('Cannot enable edit mode: ' + e.message);
            }
        }

        function disableFrameEditing(frame) {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                
                const toolbar = doc.getElementById('editor-toolbar');
                if (toolbar) toolbar.remove();
                
                const editableElements = doc.querySelectorAll('[contenteditable="true"]');
                editableElements.forEach(el => {
                    el.removeAttribute('contenteditable');
                    el.classList.remove('editor-highlight', 'editor-editing');
                });
            } catch (e) {
                console.log('Cannot disable editing');
            }
        }

        function trackChange(elementId, content) {
            editorChanges[elementId] = content;
        }

        async function saveEditorChanges() {
            const frame = document.getElementById('editorFrame');
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                
                const configUpdates = {};
                
                const configMappings = {
                    'siteTitle': 'site_title',
                    'siteSubtitle': 'site_subtitle',
                    'mainTitle': 'hero_title',
                    'mainDescription': 'hero_subtitle'
                };
                
                for (const [elementId, configKey] of Object.entries(configMappings)) {
                    const el = doc.getElementById(elementId);
                    if (el) {
                        configUpdates[configKey] = el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' 
                            ? el.value 
                            : el.innerHTML;
                    }
                }
                
                const editedElements = doc.querySelectorAll('[data-edited="true"]');
                const newEdits = {};
                editedElements.forEach((el, index) => {
                    const editId = el.getAttribute('data-edit-id');
                    if (editId) {
                        newEdits[editId] = {
                            editId: editId,
                            content: el.innerHTML,
                            style: el.getAttribute('style') || '',
                            page: currentEditorPage
                        };
                    }
                });
                
                if (Object.keys(newEdits).length > 0) {
                    const existingRes = await fetch('/api/config');
                    const existingConfig = await existingRes.json();
                    const customEditsKey = 'custom_edits_' + currentEditorPage;
                    
                    let existingEdits = {};
                    if (existingConfig[customEditsKey]) {
                        try {
                            const existingArray = JSON.parse(existingConfig[customEditsKey]);
                            existingArray.forEach(edit => {
                                existingEdits[edit.editId] = edit;
                            });
                        } catch (e) {}
                    }
                    
                    const mergedEdits = { ...existingEdits, ...newEdits };
                    configUpdates[customEditsKey] = JSON.stringify(Object.values(mergedEdits));
                }
                
                if (Object.keys(configUpdates).length > 0) {
                    try {
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(configUpdates)
                        });
                        if (!res.ok) throw new Error('Failed to save');
                        
                        editedElements.forEach(el => el.removeAttribute('data-edited'));
                        editorChanges = {};
                        
                        alert('Changes saved successfully! The changes are now live on your site.');
                    } catch (error) {
                        alert('Error saving changes: ' + error.message);
                    }
                } else {
                    alert('No changes detected. Try editing some content first.');
                }
            } catch (e) {
                console.error('Save error:', e);
                alert('Could not save changes from the visual editor. Please use the Site Content tab to make changes.');
            }
        }

        function setEditorView(view) {
            const frame = document.getElementById('editorFrame');
            const container = frame.parentElement;
            
            switch(view) {
                case 'mobile':
                    frame.style.width = '375px';
                    frame.style.margin = '0 auto';
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    break;
                case 'tablet':
                    frame.style.width = '768px';
                    frame.style.margin = '0 auto';
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    break;
                default:
                    frame.style.width = '100%';
                    frame.style.margin = '0';
                    container.style.display = 'block';
            }
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'elementSelected') {
                selectedElement = event.data.id;
            }
        });

        function applyStyleToSelected(property, value) {
            const frame = document.getElementById('editorFrame');
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                const focused = doc.activeElement;
                if (focused && focused.getAttribute('contenteditable') === 'true') {
                    focused.style[property] = value;
                    focused.setAttribute('data-edited', 'true');
                }
            } catch (e) {
                console.log('Cannot apply style');
            }
        }
    </script>
</body>
</html>
